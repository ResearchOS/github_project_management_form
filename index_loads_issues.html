<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Status Update</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f6f8fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 {
            color: #24292f;
            border-bottom: 1px solid #d1d9e0;
            padding-bottom: 10px;
        }
        .issue-item {
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            background-color: #f6f8fa;
        }
        .issue-title {
            font-weight: 600;
            color: #0969da;
            margin-bottom: 8px;
        }
        .issue-meta {
            font-size: 14px;
            color: #656d76;
            margin-bottom: 12px;
        }
        .status-options {
            margin: 12px 0;
        }
        .status-options label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
        }
        .status-options input[type="radio"] {
            margin-right: 8px;
        }
        .comment-box {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            font-family: inherit;
            resize: vertical;
        }
        .submit-btn {
            background-color: #1f883d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
        }
        .submit-btn:hover {
            background-color: #1a7f37;
        }
        .loading {
            text-align: center;
            color: #656d76;
            font-style: italic;
        }
        .error {
            color: #d1242f;
            background-color: #fff8f8;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
        }
        .auth-section {
            background-color: #fff8dc;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #e1cc8a;
        }
        .auth-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“‹ Weekly Status Update</h1>
        
        <div class="auth-section">
            <h3>GitHub Authentication</h3>
            <p>Enter your GitHub repository details:</p>
            <input type="text" id="username" class="auth-input" placeholder="GitHub username (assignee)" value="">
            <input type="text" id="repo" class="auth-input" placeholder="Repository name (e.g., my-project)" value="">
            <input type="text" id="owner" class="auth-input" placeholder="Repository owner/organization" value="">
            <button onclick="loadIssues()" class="submit-btn">Load My Issues</button>
            <p style="font-size: 12px; color: #656d76; margin-top: 8px;">
                <strong>Note:</strong> This uses GitHub's public API. For private repositories, you may hit rate limits or access restrictions.
            </p>
        </div>

        <form id="statusForm">
            <div id="issuesContainer">
                <div class="loading">Click "Load My Issues" to fetch your assigned issues...</div>
            </div>
            
            <button type="submit" class="submit-btn" id="submitBtn" style="display: none;">Submit Status Updates</button>
        </form>
    </div>

    <script>
        let currentIssues = [];
        
        // Demo data for testing without API
        const demoIssues = [
            {
                number: 123,
                title: "Implement user authentication system",
                html_url: "https://github.com/your-org/my-project/issues/123",
                labels: [{ name: "enhancement" }, { name: "backend" }],
                milestone: { title: "v2.0" }
            },
            {
                number: 456,
                title: "Fix responsive design on mobile devices",
                html_url: "https://github.com/your-org/my-project/issues/456",
                labels: [{ name: "bug" }, { name: "frontend" }],
                milestone: null
            },
            {
                number: 789,
                title: "Update documentation for API endpoints",
                html_url: "https://github.com/your-org/my-project/issues/789",
                labels: [{ name: "documentation" }],
                milestone: { title: "v1.5" }
            }
        ];

        async function loadIssues() {
            const username = document.getElementById('username').value;
            const repo = document.getElementById('repo').value;
            const owner = document.getElementById('owner').value;
            
            if (!username || !repo || !owner) {
                alert('Please fill in all fields');
                return;
            }
            
            const container = document.getElementById('issuesContainer');
            container.innerHTML = '<div class="loading">Loading your assigned issues...</div>';
            
            try {
                // Fetch issues assigned to the user
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/issues?assignee=${username}&state=open&per_page=100`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`Repository ${owner}/${repo} not found or not accessible`);
                    } else if (response.status === 403) {
                        throw new Error('API rate limit exceeded or repository is private. Try again later.');
                    } else {
                        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                    }
                }
                
                const issues = await response.json();
                
                // Filter out pull requests (GitHub API returns both issues and PRs)
                const actualIssues = issues.filter(issue => !issue.pull_request);
                
                currentIssues = actualIssues;
                renderIssues(currentIssues);
                document.getElementById('submitBtn').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading issues:', error);
                container.innerHTML = `<div class="error">Error loading issues: ${error.message}</div>`;
            }
        }
        
        function renderIssues(issues) {
            const container = document.getElementById('issuesContainer');
            
            if (issues.length === 0) {
                container.innerHTML = '<div class="loading">No assigned issues found for this user.</div>';
                document.getElementById('submitBtn').style.display = 'none';
                return;
            }
            
            container.innerHTML = issues.map(issue => `
                <div class="issue-item">
                    <div class="issue-title">
                        <a href="${issue.html_url}" target="_blank">#${issue.number}: ${issue.title}</a>
                    </div>
                    <div class="issue-meta">
                        ${issue.labels.map(label => `<span style="background: #${label.color || 'e1e4e8'}; color: ${getContrastColor(label.color || 'e1e4e8')}; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 4px;">${label.name}</span>`).join('')}
                        ${issue.milestone ? `â€¢ Milestone: ${issue.milestone.title}` : ''}
                        ${issue.created_at ? `â€¢ Created: ${new Date(issue.created_at).toLocaleDateString()}` : ''}
                    </div>
                    
                    <div class="status-options">
                        <strong>Status Update:</strong>
                        <label>
                            <input type="radio" name="status_${issue.number}" value="in_progress" checked>
                            ðŸ”„ Still in progress
                        </label>
                        <label>
                            <input type="radio" name="status_${issue.number}" value="completed">
                            âœ… Completed
                        </label>
                        <label>
                            <input type="radio" name="status_${issue.number}" value="blocked">
                            ðŸš« Blocked
                        </label>
                        <label>
                            <input type="radio" name="status_${issue.number}" value="needs_review">
                            ðŸ‘€ Needs review
                        </label>
                    </div>
                    
                    <textarea 
                        name="comment_${issue.number}" 
                        class="comment-box" 
                        placeholder="Add any comments or updates about this issue..."></textarea>
                </div>
            `).join('');
        }
        
        // Helper function to determine text color based on background color
        function getContrastColor(hexColor) {
            // Convert hex to RGB
            const r = parseInt(hexColor.substr(0, 2), 16);
            const g = parseInt(hexColor.substr(2, 2), 16);
            const b = parseInt(hexColor.substr(4, 2), 16);
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            // Return black for light colors, white for dark colors
            return luminance > 0.5 ? '#000000' : '#ffffff';
        }
        
        document.getElementById('statusForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const repo = document.getElementById('repo').value;
            const owner = document.getElementById('owner').value;
            
            // Collect form data
            const updates = currentIssues.map(issue => {
                const status = document.querySelector(`input[name="status_${issue.number}"]:checked`)?.value;
                const comment = document.querySelector(`textarea[name="comment_${issue.number}"]`)?.value;
                
                return {
                    issue_number: issue.number,
                    issue_title: issue.title,
                    status: status,
                    comment: comment || '',
                    user: username
                };
            });
            
            // Generate the status update issue body
            const updateBody = generateUpdateIssue(updates, username);
            
            // Show the generated issue for demo purposes
            showGeneratedIssue(updateBody, owner, repo);
        });
        
        function generateUpdateIssue(updates, username) {
            const timestamp = new Date().toISOString().split('T')[0];
            
            let body = `# Weekly Status Update - ${timestamp}\n\n`;
            body += `**Reporter:** @${username}\n\n`;
            body += `<!-- STATUS_UPDATE_DATA\n`;
            body += JSON.stringify(updates, null, 2);
            body += `\n-->\n\n`;
            body += `## Summary\n\n`;
            
            updates.forEach(update => {
                const statusEmoji = {
                    'in_progress': 'ðŸ”„',
                    'completed': 'âœ…',
                    'blocked': 'ðŸš«',
                    'needs_review': 'ðŸ‘€'
                };
                
                body += `### Issue #${update.issue_number}: ${update.issue_title}\n`;
                body += `**Status:** ${statusEmoji[update.status]} ${update.status.replace('_', ' ')}\n`;
                if (update.comment) {
                    body += `**Comment:** ${update.comment}\n`;
                }
                body += `\n`;
            });
            
            return body;
        }
        
        function showGeneratedIssue(issueBody, owner, repo) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <h2>Status Update Generated!</h2>
                    <p>In a real implementation, this would create a new issue in <strong>${owner}/${repo}</strong> with the following content:</p>
                    <pre style="background: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap;">${issueBody}</pre>
                    <p><strong>Next steps:</strong> The GitHub Action would automatically process this issue and update your project issues accordingly.</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="submit-btn">Close</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Remove auto-load demo data since we're now using real API
        window.addEventListener('load', function() {
            // Just show the initial loading message
            document.getElementById('issuesContainer').innerHTML = '<div class="loading">Click "Load My Issues" to fetch your assigned issues...</div>';
        });
    </script>
</body>
</html>